var AutoSuggester=new Class({Implements:Options,options:{rgxp:"[^ |\n]+$",class_input_mirror:"autosuggester-input-mirror",class_input_mirror_container:"autosuggester-input-mirror-container",class_input_mirror_caret:"autosuggester-input-mirror-caret",class_box:"autosuggester-box",class_box_container:"autosuggester-box-container",class_box_list:"autosuggester-box-list",class_box_list_item:"autosuggester-box-list-item",class_box_list_item_active:"autosuggester-box-list-item-active",class_box_list_item_value:"autosuggester-box-list-item-value",class_box_list_item_content:"autosuggester-box-list-item-content"},keys_mapper:{13:"enter",27:"esc",38:"up",40:"down"},initialize:function(e,t,n){this.input=e;this.setOptions(n);this.source=t;this.tinyMCE=false;this.rgxp=new RegExp(this.options.rgxp,"i");this.input.set("autocomplete","off");setTimeout(function(){if(window.tinyMCE){try{this.tinyMCE=tinyMCE.get(this.input.get("id"))}catch(e){}}if(this.input.get("tag")=="textarea"&&!this.tinyMCE){this.setUpMirror()}this.setUpSuggestions();this.registerObservers()}.bind(this),500)},setUpSuggestions:function(){var e,t;this.box_container=new Element("div",{"class":this.options.class_box_container});this.box=new Element("div",{id:this.input.get("id")+"_autosuggester","class":this.options.class_box});this.box_list=new Element("ul",{"class":this.options.class_box_list});this.box_list_items=[];this.box_list_items_visible=[];for(e=0;e<this.source.length;e+=1){this.box_list_items[e]=(new Element("li",{"class":this.options.class_box_list_item,html:'<div class="'+this.options.class_box_list_item_value+'">'+this.source[e]["value"]+'</div><div class="'+this.options.class_box_list_item_content+'">'+this.source[e]["content"]+"</div>"})).inject(this.box_list);this.box_list_items_visible.push(e)}this.box_list.inject(this.box);this.box.inject(this.box_container);this.box_container.inject(document.body);this.box_visible=false},setUpMirror:function(){var e=["box-sizing","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","line-height","max-height","min-height","padding-bottom","padding-left","padding-right","padding-top","text-decoration","text-indent","text-transform","width","word-spacing"];var t=window.getComputedStyle(this.input);var n;this.input_mirror=new Element("div",{"class":this.options.class_input_mirror,text:this.input.get("value")});this.input_mirror_caret=new Element("span",{"class":this.options.class_input_mirror_caret,html:"&nbsp;"});for(n=0;n<e.length;n++){this.input_mirror.setStyle(e[n],t[e[n]])}this.input_mirror_caret.inject(this.input_mirror);this.input_mirror.inject(this.input,"after")},registerObservers:function(){var e;if(!this.tinyMCE){this.input.addEvents({keyup:this.eventKeyUp.bind(this),keydown:this.eventKeyDown.bind(this)})}if(this.tinyMCE){if(window.tinyMCE.majorVersion=="4"){this.tinyMCE.on("keyUp",function(e){this.eventKeyUp.call(this,e)}.bind(this));this.tinyMCE.off("keyDown");this.tinyMCE.on("keyDown",function(e){this.eventKeyDown.call(this,e)}.bind(this))}else{this.tinyMCE.onKeyUp.add(function(e,t){this.eventKeyUp.call(this,t)}.bind(this));this.tinyMCE.onKeyDown.listeners=[];this.tinyMCE.onKeyDown.add(function(e,t){this.eventKeyDown.call(this,t)}.bind(this))}}for(e=0;e<this.box_list_items.length;e++){this.box_list_items[e].addEvents({mouseenter:function(e){this.highlightItem(this.box_list_items.indexOf(e.target))}.bind(this),click:function(e){e.preventDefault();this.selectItem()}.bind(this)})}},showBox:function(){if(!this.box_visible){var e,t,n;var r={x:0,y:0};if(this.tinyMCE){r.x=this.tinyMCE.selection.getRng().getClientRects()[0].left;r.y=this.tinyMCE.selection.getNode().getClientRects()[0].top+this.tinyMCE.selection.getNode().getClientRects()[0].height}else if(this.input_mirror){e=this.getCaretIndex();t=this.input.get("value");n=[t.substr(0,e),t.substr(e,t.length)];this.input_mirror.set("html","");this.input_mirror.grab(document.createTextNode(n[0]));this.input_mirror.grab(this.input_mirror_caret);this.input_mirror.grab(document.createTextNode(n[1]));r=this.input_mirror_caret.getPosition(this.input_mirror);r.y=r.y+this.input_mirror_caret.getSize().y}else{r.y=this.input.getSize().y}for(i=0;i<this.box_list_items.length;i++){this.box_list_items[i].removeClass("invisible")}if(this.tinyMCE){this.setPosition(this.box_container,$(this.input.get("id")+"_ifr").getPosition())}else{this.setPosition(this.box_container,this.input.getPosition())}this.current_list_item=null;this.box.setStyle("display","block");this.setPosition(this.box,r);this.box.scrollTo(0,0);this.box_visible=true;document.body.addEvent("click",this.hideBox.bind(this))}},hideBox:function(){this.box.setStyle("display","none");this.box_visible=false;for(i=0;i<this.box_list_items.length;i++){this.box_list_items[i].removeClass(this.options.class_box_list_item_active)}},eventKeyUp:function(e){if(this.getKeyCode(e)=="esc"){return}var t,n,r,i,s;var o=true;if(this.tinyMCE){r=this.tinyMCE.selection.getRng();t=r.startContainer.wholeText;n=r.startOffset;if(t&&n==r.startContainer.length&&r.startContainer.textContent.length!=t.length){n=n+(t.length-r.startContainer.textContent.length)}}else{t=this.input.get("value");n=this.getCaretIndex()}if(!t){this.hideBox();return}this.filter_text="";t=t.slice(0,n);s=this.rgxp.exec(t);if(s){this.showBox();this.filter_text=s[0];if(!this.filterItems()){this.hideBox()}}},eventKeyDown:function(e){if(!this.box_visible){return}var t=this.box_list_items_visible.indexOf(this.current_list_item);switch(this.getKeyCode(e)){case"esc":this.hideBox();break;case"enter":if(this.current_list_item===null){return}e.preventDefault();this.selectItem();break;case"up":e.preventDefault();if(t===-1){this.highlightItem(this.box_list_items_visible.length-1)}else if(t>0){this.highlightItem(this.box_list_items_visible[t-1])}break;case"down":e.preventDefault();if(t===-1){this.highlightItem(this.box_list_items_visible[0])}else if(t<this.box_list_items_visible.length-1){this.highlightItem(this.box_list_items_visible[t+1])}break}},highlightItem:function(e){var t=parseInt(this.box.getStyle("maxHeight"));var n=this.box.getScroll().y;var r=t+n;var i=this.box_list_items[e].getPosition(this.box).y+n;var s=i+this.box_list_items[e].getCoordinates().height;if(this.current_list_item!==null){this.box_list_items[this.current_list_item].removeClass(this.options.class_box_list_item_active)}this.box_list_items[e].addClass(this.options.class_box_list_item_active);this.current_list_item=e;if(s>=r){this.box.scrollTo(0,s-t>0?s-t:0)}else if(i<n){this.box.scrollTo(0,i)}},selectItem:function(){var e,t,n;var r=this.source[this.current_list_item]["value"];if(this.filter_text.length>0){r=r.substr(this.filter_text.length,r.length)}if(this.tinyMCE){this.tinyMCE.selection.setContent(r)}else{e=this.input.get("value");t=this.getCaretIndex();n=t+r.length;this.input.set("value",e.slice(0,t)+r+e.slice(t,e.length));this.input.setSelectionRange(n,n)}this.hideBox()},filterItems:function(){var e,t;var n=new RegExp("^"+this.filter_text+"(?!$)","i");for(e=0;e<this.box_list_items.length;e++){if(n.test(this.source[e]["value"])){this.box_list_items[e].removeClass("invisible");this.box_list_items_visible.include(e)}else{this.box_list_items[e].addClass("invisible");this.box_list_items_visible.erase(e)}}return this.box_list_items_visible.length>0},getCaretIndex:function(){return this.input.selectionStart},getKeyCode:function(e){var t;if(this.tinyMCE){t=e.keyCode}else{t=e.event.keyCode}return this.keys_mapper[t]},setPosition:function(e,t){e.setStyle("left",t.x);e.setStyle("top",t.y)}})